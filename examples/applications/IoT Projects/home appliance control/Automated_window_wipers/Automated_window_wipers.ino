// -----------------------------------------------------------------------------
// Project: Window Cleaner Wiper
// File: Window_Cleaner_Wiper.ino
// Description: Controls a servo motor to sweep from 0 to 180 degrees and back
//              when a switch is activated from the Arduino IoT Cloud dashboard.
// -----------------------------------------------------------------------------

// Include necessary libraries for Arduino IoT Cloud and Servo motor.
#include "thingProperties.h"   // Auto-generated by Arduino IoT Cloud
#include <Servo.h>             // For controlling a servo motor

// -----------------------------------------------------------------------------
// Pin Definitions
// -----------------------------------------------------------------------------
#define SERVO_PIN D9           // Digital pin for Servo motor control

// -----------------------------------------------------------------------------
// Actuator Object
// -----------------------------------------------------------------------------
Servo wiperServo; // Create a servo object

// -----------------------------------------------------------------------------
// Constants
// -----------------------------------------------------------------------------
const int SWEEP_DELAY_MS = 15; // Delay between each servo step for smooth motion (milliseconds)
const int SWEEP_START_ANGLE = 0;   // Start angle for the sweep
const int SWEEP_END_ANGLE = 180;   // End angle for the sweep
const int SWEEP_STEP_SIZE = 1;     // Degrees to move per step

// -----------------------------------------------------------------------------
// Setup Function: Runs once when the board starts
// -----------------------------------------------------------------------------
void setup() {
  // Initialize Serial communication for debugging
  Serial.begin(9600);
  while (!Serial); // Wait for Serial Monitor to open

  // Initialize Arduino IoT Cloud properties
  initProperties();

  // Connect to Arduino IoT Cloud
  ArduinoCloud.begin(ArduinoIoTPreferredConnection);

  // Set debug message level for more detailed output
  setDebugMessageLevel(2);
  ArduinoCloud.printDebugInfo();

  // Attach the servo to its pin
  wiperServo.attach(SERVO_PIN);
  wiperServo.write(SWEEP_START_ANGLE); // Ensure servo is at the starting position
  Serial.println("Servo initialized and set to 0 degrees.");

  // Initialize Cloud property
  wiperOn = false; // Wiper is off by default

  Serial.println("Setup complete for Window Cleaner Wiper.");
}

// -----------------------------------------------------------------------------
// Loop Function: Runs repeatedly
// -----------------------------------------------------------------------------
void loop() {
  // Update Arduino IoT Cloud state (sends/receives data)
  ArduinoCloud.update();

  // No continuous sensor reading or complex logic needed in loop,
  // actions are triggered by the onWiperOnChange callback.
}

// -----------------------------------------------------------------------------
// Function to perform a single sweep action (0 to 180 and back to 0)
// -----------------------------------------------------------------------------
void performWiperSweep() {
  Serial.println("Performing wiper sweep...");

  // Sweep from start to end angle
  for (int angle = SWEEP_START_ANGLE; angle <= SWEEP_END_ANGLE; angle += SWEEP_STEP_SIZE) {
    wiperServo.write(angle);
    delay(SWEEP_DELAY_MS);
  }

  // Sweep from end back to start angle
  for (int angle = SWEEP_END_ANGLE; angle >= SWEEP_START_ANGLE; angle -= SWEEP_STEP_SIZE) {
    wiperServo.write(angle);
    delay(SWEEP_DELAY_MS);
  }
  Serial.println("Wiper sweep complete.");
}

// -----------------------------------------------------------------------------
// Arduino IoT Cloud Callback
// -----------------------------------------------------------------------------

/*
  Callback function for when the wiperOn property changes in the Cloud.
  This triggers the wiper sweep action.
*/
void onWiperOnChange() {
  Serial.print("Cloud changed Wiper On to: ");
  Serial.println(wiperOn ? "TRUE" : "FALSE");

  if (wiperOn) {
    performWiperSweep();
    // After performing the sweep, reset the wiperOn property to false.
    // This makes the Cloud switch act like a momentary button.
    wiperOn = false;
    Serial.println("Wiper state reset to OFF in Cloud.");
  }
  // If wiperOn becomes false from Cloud, no action needed as sweep is already off.
}
